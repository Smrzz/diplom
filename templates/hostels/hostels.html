{% load static %}
<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ö—É–≤–∞365</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />
    <script src="{% static 'js/pr.js' %}"></script>
  </head>
  <body>
    <header class="header">
      <div class="header-content">
        <div class="logo">
          <a href="{% url 'home' %}">
            <img src="{% static 'imgs/logo.svg' %}" class="logo" />
          </a>
        </div>
        <ul class="navbar">
          <a href="{% url 'hostels' %}"><li class="nav">–ì–æ—Å—Ç–∏–Ω–∏—Ü–∞</li></a>
          <a href="{% url 'rental' %}"><li class="nav">–ü—Ä–æ–∫–∞—Ç</li></a>
          <a href="{% url 'news' %}"><li class="nav">–ù–æ–≤–æ—Å—Ç–∏</li></a>
          <a href="https://rtsp.me/embed/h3Ykkn7E/"><li class="nav">–í–µ–±-–∫–∞–º–µ—Ä–∞</li></a>
        </ul>
      </div>
    </header>

    <main class="gast-container">
      <section class="gast-main">
        <div class="gast-blocks">
          <!-- –û–¥–Ω–æ–º–µ—Å—Ç–Ω—ã–π -->
          <div class="gast-block">
            <img src="{% static 'imgs/1mest 1.png' %}" class="gast-pic" />
            <div class="text-gast">
              <h3 class="title-gast">–û–¥–Ω–æ–º–µ—Å—Ç–Ω—ã–π –Ω–æ–º–µ—Ä</h3>
              <h2 class="subtitle-gast">–í –±—É–¥–Ω–∏–µ –¥–Ω–∏ 2000—Ä/—Å—É—Ç–∫–∏ <br />–í –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–µ –¥–Ω–∏ 3000—Ä/—Å—É—Ç–∫–∏</h2>
              <button class="btn-gast" onclick="openForm('–û–¥–Ω–æ–º–µ—Å—Ç–Ω—ã–π')">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
          </div>

          <!-- –î–≤—É—Ö–º–µ—Å—Ç–Ω—ã–π -->
          <div class="gast-block">
            <img src="{% static 'imgs/2mest.jpg' %}" class="gast-pic" />
            <div class="text-gast">
              <h3 class="title-gast">–î–≤—É—Ö–º–µ—Å—Ç–Ω—ã–π –Ω–æ–º–µ—Ä</h3>
              <h2 class="subtitle-gast">–í –±—É–¥–Ω–∏–µ –¥–Ω–∏ 3000—Ä/—Å—É—Ç–∫–∏ <br />–í –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–µ –¥–Ω–∏ 4000—Ä/—Å—É—Ç–∫–∏</h2>
              <button class="btn-gast" onclick="openForm('–î–≤—É—Ö–º–µ—Å—Ç–Ω—ã–π')">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
          </div>

          <!-- –ß–µ—Ç—ã—Ä—ë—Ö–º–µ—Å—Ç–Ω—ã–π -->
          <div class="gast-block">
            <img src="{% static 'imgs/3mest.jpg' %}" class="gast-pic" />
            <div class="text-gast">
              <h3 class="title-gast">–ß–µ—Ç—ã—Ä—ë—Ö–º–µ—Å—Ç–Ω—ã–π –Ω–æ–º–µ—Ä</h3>
              <h2 class="subtitle-gast">–í –±—É–¥–Ω–∏–µ –¥–Ω–∏ 5000—Ä/—Å—É—Ç–∫–∏ <br />–í –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–µ –¥–Ω–∏ 7000—Ä/—Å—É—Ç–∫–∏</h2>
              <button class="btn-gast" onclick="openForm('–ß–µ—Ç—ã—Ä—ë—Ö–º–µ—Å—Ç–Ω—ã–π')">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="footer">
      <div class="footer-content">
        <div class="logo">
          <a href="{% url 'home' %}">
            <img src="{% static 'imgs/logo.svg' %}" class="logo" />
          </a>
        </div>
        <div class="social">
          <a href="https://vk.com/kuva365"><img src="{% static 'imgs/vk.svg' %}" class="footer-icons" /></a>
          <a href="https://t.me/s/kuva365"><img src="{% static 'imgs/tg.svg' %}" class="footer-icons" /></a>
        </div>
        <h4 class="footer-num">8 (800) 55 35 35</h4>
      </div>
    </footer>

    <!-- üßæ –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û -->
    <div id="bookingPopup" class="form-popup">
      <form method="post" action="{% url 'book_room' %}" class="form-container">
        <button type="button" class="close-btn" onclick="closeForm()" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úñ</button>
        <h2>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞</h2>
        {% csrf_token %}
        <input type="hidden" name="room_type" id="popupRoomType" />

        <div class="form-group">
          <label for="id_name"><b>–ò–º—è</b></label>
          {{ form.name }}
          {% if form.name.errors %}
          <div class="error-message">{{ form.name.errors.0 }}</div>
          {% endif %}
        </div>
        
        <div class="form-group">
          <label for="id_phone"><b>–¢–µ–ª–µ—Ñ–æ–Ω</b></label>
          {{ form.phone }}
          {% if form.phone.errors %}
          <div class="error-message">{{ form.phone.errors.0 }}</div>
          {% endif %}
        </div>
        
        <div class="form-group">
          <label for="id_check_in"><b>–î–∞—Ç–∞ –∑–∞–µ–∑–¥–∞</b></label>
          {{ form.check_in }}
          {% if form.check_in.errors %}
          <div class="error-message">{{ form.check_in.errors.0 }}</div>
          {% endif %}
        </div>
        
        <div class="form-group">
          <label for="id_check_out"><b>–î–∞—Ç–∞ –≤—ã–µ–∑–¥–∞</b></label>
          {{ form.check_out }}
          {% if form.check_out.errors %}
          <div class="error-message">{{ form.check_out.errors.0 }}</div>
          {% endif %}
        </div>
        
        {% if form.non_field_errors %}
        <div class="error-message">
          {% for error in form.non_field_errors %}
          {{ error }}
          {% endfor %}
        </div>
        {% endif %}
        
        <button type="submit" class="btn">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–º–µ—Ä</button>
      </form>
    </div>

    <!--  JS -->
    <script>
      const unavailableDates = {{ unavailable_json|safe }};
      const today = "{{ today|date:'Y-m-d' }}";
      
      console.log('–î–∞–Ω–Ω—ã–µ –æ –∑–∞–Ω—è—Ç—ã—Ö –¥–∞—Ç–∞—Ö:', unavailableDates);
      console.log('–°–µ–≥–æ–¥–Ω—è—à–Ω—è—è –¥–∞—Ç–∞:', today);

      function isDateInPeriod(date, period) {
        const checkDate = new Date(date);
        const startDate = new Date(period.start);
        const endDate = new Date(period.end);
        return checkDate >= startDate && checkDate < endDate;
      }

      function isPeriodAvailable(startDate, endDate, periods) {
        const checkStart = new Date(startDate);
        const checkEnd = new Date(endDate);
        
        for (const period of periods) {
          const periodStart = new Date(period.start);
          const periodEnd = new Date(period.end);
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–æ–≤
          if (checkStart < periodEnd && checkEnd > periodStart) {
            return false;
          }
        }
        return true;
      }

      function blockDates(roomType, checkInInput, checkOutInput) {
        const disabledDatesByRoom = unavailableDates[roomType] || {};
        console.log(`–ó–∞–Ω—è—Ç—ã–µ –¥–∞—Ç—ã –¥–ª—è ${roomType}:`, disabledDatesByRoom);

        function disable(input) {
          const copy = input.cloneNode(true); // –ö–ª–æ–Ω–∏—Ä—É–µ–º —Å–æ –≤—Å–µ–º–∏ –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏
          copy.value = input.value;
          input.parentNode.replaceChild(copy, input);
          
          copy.addEventListener("input", () => {
            console.log('–í—ã–±—Ä–∞–Ω–∞ –¥–∞—Ç–∞:', copy.value);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞—Ç–∞ –Ω–µ –≤ –ø—Ä–æ—à–ª–æ–º
            const selectedDate = new Date(copy.value);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (selectedDate < today) {
              alert("–ù–µ–ª—å–∑—è –≤—ã–±—Ä–∞—Ç—å –¥–∞—Ç—É –≤ –ø—Ä–æ—à–ª–æ–º");
              copy.value = "";
              return;
            }

            if (input === checkInInput) {
              // –î–ª—è –¥–∞—Ç—ã –∑–∞–µ–∑–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –Ω–æ–º–µ—Ä–∞
              let availableRooms = [];
              
              // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –Ω–æ–º–µ—Ä–æ–≤ –¥–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞
              for (const roomNumber in disabledDatesByRoom) {
                const periods = disabledDatesByRoom[roomNumber];
                let isRoomAvailable = true;
                
                // –ï—Å–ª–∏ —É –Ω–æ–º–µ—Ä–∞ –µ—Å—Ç—å –ø–µ—Ä–∏–æ–¥—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏—Ö
                if (periods && periods.length > 0) {
                  for (const period of periods) {
                    if (isDateInPeriod(copy.value, period)) {
                      console.log(`–î–∞—Ç–∞ ${copy.value} –∑–∞–Ω—è—Ç–∞ –≤ –Ω–æ–º–µ—Ä–µ ${roomNumber}`);
                      isRoomAvailable = false;
                      break;
                    }
                  }
                }
                
                if (isRoomAvailable) {
                  availableRooms.push(roomNumber);
                }
              }
              
              console.log(`–î–æ—Å—Ç—É–ø–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ –¥–ª—è –¥–∞—Ç—ã ${copy.value}:`, availableRooms);
              
              // –ï—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Å–≤–æ–±–æ–¥–Ω—ã–π –Ω–æ–º–µ—Ä, –ø–æ–∑–≤–æ–ª—è–µ–º –≤—ã–±—Ä–∞—Ç—å –¥–∞—Ç—É
              if (availableRooms.length > 0) {
                console.log(`–î–∞—Ç–∞ ${copy.value} –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –∑–∞–µ–∑–¥–∞ –≤ –Ω–æ–º–µ—Ä–∞—Ö: ${availableRooms.join(', ')}`);
                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º –ø–æ–ª–µ
                checkInInput.value = copy.value;
                return;
              }
              
              alert("–≠—Ç–∞ –¥–∞—Ç–∞ –∑–∞–Ω—è—Ç–∞ –≤–æ –≤—Å–µ—Ö –Ω–æ–º–µ—Ä–∞—Ö –¥–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞");
              copy.value = "";
              checkInInput.value = "";
            } else {
              // –î–ª—è –¥–∞—Ç—ã –≤—ã–µ–∑–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–∏–æ–¥ –º–µ–∂–¥—É –∑–∞–µ–∑–¥–æ–º –∏ –≤—ã–µ–∑–¥–æ–º
              const checkInValue = checkInInput.value;
              console.log('–ó–Ω–∞—á–µ–Ω–∏–µ –¥–∞—Ç—ã –∑–∞–µ–∑–¥–∞:', checkInValue);
              
              if (!checkInValue) {
                alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∑–∞–µ–∑–¥–∞");
                copy.value = "";
                return;
              }

              const checkIn = new Date(checkInValue);
              const checkOut = new Date(copy.value);
              
              if (checkOut <= checkIn) {
                alert("–î–∞—Ç–∞ –≤—ã–µ–∑–¥–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–∑–∂–µ –¥–∞—Ç—ã –∑–∞–µ–∑–¥–∞");
                copy.value = "";
                return;
              }

              let availableRooms = [];
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π –Ω–æ–º–µ—Ä
              for (const roomNumber in disabledDatesByRoom) {
                const periods = disabledDatesByRoom[roomNumber];
                let isRoomAvailable = true;
                
                // –ï—Å–ª–∏ —É –Ω–æ–º–µ—Ä–∞ –µ—Å—Ç—å –ø–µ—Ä–∏–æ–¥—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏—Ö
                if (periods && periods.length > 0) {
                  if (!isPeriodAvailable(
                    checkIn.toISOString().split('T')[0],
                    checkOut.toISOString().split('T')[0],
                    periods
                  )) {
                    isRoomAvailable = false;
                  }
                }
                
                if (isRoomAvailable) {
                  availableRooms.push(roomNumber);
                }
              }
              
              console.log(`–î–æ—Å—Ç—É–ø–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ –¥–ª—è –ø–µ—Ä–∏–æ–¥–∞ —Å ${checkIn.toISOString().split('T')[0]} –ø–æ ${checkOut.toISOString().split('T')[0]}:`, availableRooms);
              
              // –ï—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Å–≤–æ–±–æ–¥–Ω—ã–π –Ω–æ–º–µ—Ä, –ø–æ–∑–≤–æ–ª—è–µ–º –≤—ã–±—Ä–∞—Ç—å –¥–∞—Ç—É
              if (availableRooms.length > 0) {
                console.log(`–ü–µ—Ä–∏–æ–¥ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –Ω–æ–º–µ—Ä–∞—Ö: ${availableRooms.join(', ')}`);
                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º –ø–æ–ª–µ
                checkOutInput.value = copy.value;
                return;
              }
              
              alert("–í—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –∑–∞–Ω—è—Ç –≤–æ –≤—Å–µ—Ö –Ω–æ–º–µ—Ä–∞—Ö –¥–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞");
              copy.value = "";
              checkOutInput.value = "";
            }
          });
        }

        disable(checkInInput);
        disable(checkOutInput);
      }

      function openForm(roomType) {
        const popup = document.getElementById("bookingPopup");
        popup.classList.add("active");
        document.getElementById("popupRoomType").value = roomType;

        const checkIn = document.getElementById("id_check_in");
        const checkOut = document.getElementById("id_check_out");
        
        // –û—á–∏—â–∞–µ–º –ø–æ–ª—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ñ–æ—Ä–º—ã
        checkIn.value = "";
        checkOut.value = "";
        
        blockDates(roomType, checkIn, checkOut);
      }

      function closeForm() {
        document.getElementById("bookingPopup").classList.remove("active");
      }

      window.addEventListener("click", function (e) {
        const popup = document.getElementById("bookingPopup");
        if (e.target === popup) {
          closeForm();
        }
      });

      // –ú–∞—Å–∫–∞ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
      document.getElementById('id_phone').addEventListener('input', function(e) {
          let value = e.target.value.replace(/\D/g, '');

          // –ï—Å–ª–∏ –Ω–æ–º–µ—Ä –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 8 –∏–ª–∏ 7, —É–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—É—é —Ü–∏—Ñ—Ä—É (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ 10 —Ü–∏—Ñ—Ä –ø–æ—Å–ª–µ –∫–æ–¥–∞ —Å—Ç—Ä–∞–Ω—ã)
          if (value.startsWith('8')) value = value.slice(1);
          if (value.startsWith('7')) value = value.slice(1);

          value = value.slice(0, 10); // –º–∞–∫—Å–∏–º—É–º 10 —Ü–∏—Ñ—Ä –ø–æ—Å–ª–µ –∫–æ–¥–∞ —Å—Ç—Ä–∞–Ω—ã

          let masked = '+7 ';
          if (value.length > 0) masked += '(' + value.substring(0, 3);
          if (value.length >= 4) masked += ') ' + value.substring(3, 6);
          else if (value.length > 3) masked += ') ';
          if (value.length >= 7) masked += '-' + value.substring(6, 8);
          else if (value.length > 6) masked += '-' + value.substring(6, 8);
          if (value.length >= 9) masked += '-' + value.substring(8, 10);

          e.target.value = masked.trim();
      });
    </script>
    
  </body>
</html>
